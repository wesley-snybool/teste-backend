# üß© Sistema de Pagamentos - API RESTful

API RESTful para gerenciamento de clientes e cobran√ßas com suporte a m√∫ltiplos m√©todos de pagamento: **Pix**, **Cart√£o de Cr√©dito** e **Boleto Banc√°rio**.

## üìã Funcionalidades

### Gerenciamento de Clientes
- ‚úÖ Cadastro de clientes com valida√ß√£o de duplicidade (e-mail e documento)
- ‚úÖ Listagem de todos os clientes
- ‚úÖ Busca de cliente por ID
- ‚úÖ Atualiza√ß√£o de dados do cliente
- ‚úÖ Remo√ß√£o de cliente

### Gerenciamento de Cobran√ßas
- ‚úÖ Cria√ß√£o de cobran√ßas vinculadas a clientes
- ‚úÖ Suporte a tr√™s m√©todos de pagamento:
  - **Pix**: com QR Code e prazo de validade
  - **Cart√£o de Cr√©dito**: com suporte a parcelamento
  - **Boleto Banc√°rio**: com c√≥digo de barras e data de vencimento
- ‚úÖ Controle de status da cobran√ßa (pendente, pago, falhado, expirado, cancelado)
- ‚úÖ Listagem de cobran√ßas com filtro por cliente
- ‚úÖ Busca de cobran√ßa por ID
- ‚úÖ Atualiza√ß√£o de status da cobran√ßa
- ‚úÖ Remo√ß√£o de cobran√ßa

### Recursos T√©cnicos
- ‚úÖ Valida√ß√µes robustas com `class-validator`
- ‚úÖ Tratamento global de erros
- ‚úÖ Idempot√™ncia nas requisi√ß√µes POST
- ‚úÖ Documenta√ß√£o interativa com Swagger
- ‚úÖ Persist√™ncia em PostgreSQL com TypeORM
- ‚úÖ Docker Compose para facilitar execu√ß√£o

## üöÄ Tecnologias Utilizadas

- **NestJS** - Framework Node.js
- **TypeScript** - Linguagem de programa√ß√£o
- **TypeORM** - ORM para banco de dados
- **PostgreSQL** - Banco de dados relacional
- **Swagger** - Documenta√ß√£o da API
- **Docker** - Containeriza√ß√£o
- **class-validator** - Valida√ß√£o de dados

## üì¶ Pr√©-requisitos

- Node.js (v18 ou superior)
- npm ou yarn
- Docker e Docker Compose (opcional, mas recomendado)
- PostgreSQL (caso n√£o use Docker)

## ‚öôÔ∏è Instala√ß√£o e Execu√ß√£o

### Op√ß√£o 1: Usando Docker (Recomendado)

1. **Clone o reposit√≥rio**
```bash
git clone <url-do-repositorio>
cd teste-backend
```

2. **Configure as vari√°veis de ambiente**
```bash
# Crie um arquivo .env na raiz do projeto
DATABASE_HOST=go_db
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=1234
DATABASE_NAME=postgres
PORT=3000
```

3. **Inicie os containers**
```bash
docker-compose up -d
```

4. **Acesse a aplica√ß√£o**
- API: http://localhost:3000
- Documenta√ß√£o Swagger: http://localhost:3000/api/docs

### Op√ß√£o 2: Execu√ß√£o Local

1. **Clone o reposit√≥rio**
```bash
git clone <url-do-repositorio>
cd teste-backend
```

2. **Instale as depend√™ncias**
```bash
npm install
```

3. **Configure o banco de dados PostgreSQL**
```bash
# Certifique-se de ter o PostgreSQL rodando
# Crie um banco de dados chamado 'postgres'
createdb postgres
```

4. **Configure as vari√°veis de ambiente**
```bash
# Crie um arquivo .env na raiz do projeto
DATABASE_HOST=localhost
DATABASE_PORT=5433
DATABASE_USER=postgres
DATABASE_PASSWORD=1234
DATABASE_NAME=postgres
PORT=3000
```

5. **Inicie o servidor de desenvolvimento**
```bash
npm run start:dev
```

6. **Acesse a aplica√ß√£o**
- API: http://localhost:3000
- Documenta√ß√£o Swagger: http://localhost:3000/api/docs

## üìö Documenta√ß√£o da API

A documenta√ß√£o completa da API est√° dispon√≠vel atrav√©s do Swagger UI em:
```
http://localhost:3000/api/docs
```

### Endpoints Principais

#### Customers (Clientes)

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| POST | `/customers` | Criar novo cliente |
| GET | `/customers` | Listar todos os clientes |
| GET | `/customers/:id` | Buscar cliente por ID |
| PATCH | `/customers/:id` | Atualizar cliente |
| DELETE | `/customers/:id` | Remover cliente |

#### Charges (Cobran√ßas)

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| POST | `/charges` | Criar nova cobran√ßa |
| GET | `/charges` | Listar todas as cobran√ßas |
| GET | `/charges?customerId=:id` | Listar cobran√ßas de um cliente |
| GET | `/charges/:id` | Buscar cobran√ßa por ID |
| PATCH | `/charges/:id` | Atualizar status da cobran√ßa |
| DELETE | `/charges/:id` | Remover cobran√ßa |

## üß™ Exemplos de Uso

### 1. Criar um Cliente

```bash
curl -X POST http://localhost:3000/customers \
  -H "Content-Type: application/json" \
  -H "idempotency-key: 550e8400-e29b-41d4-a716-446655440000" \
  -d '{
    "name": "Jo√£o da Silva",
    "email": "joao@example.com",
    "document": "12345678900",
    "phone": "11987654321"
  }'
```

**Resposta:**
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "name": "Jo√£o da Silva",
  "email": "joao@example.com",
  "document": "12345678900",
  "phone": "11987654321",
  "createdAt": "2025-10-21T10:00:00.000Z",
  "updatedAt": "2025-10-21T10:00:00.000Z"
}
```

### 2. Criar Cobran√ßa com Pix

```bash
curl -X POST http://localhost:3000/charges \
  -H "Content-Type: application/json" \
  -H "idempotency-key: 660e8400-e29b-41d4-a716-446655440000" \
  -d '{
    "customerId": "123e4567-e89b-12d3-a456-426614174000",
    "amount": 150.00,
    "currency": "BRL",
    "paymentMethod": "pix",
    "description": "Pagamento de servi√ßo",
    "paymentDetails": {
      "pixExpiration": "2025-10-22T23:59:59Z"
    }
  }'
```

**Resposta:**
```json
{
  "id": "789e4567-e89b-12d3-a456-426614174000",
  "customerId": "123e4567-e89b-12d3-a456-426614174000",
  "amount": 150.00,
  "currency": "BRL",
  "paymentMethod": "pix",
  "status": "pending",
  "description": "Pagamento de servi√ßo",
  "pixQrCode": "00020126360014BR.GOV.BCB.PIX...",
  "pixExpiration": "2025-10-22T23:59:59.000Z",
  "createdAt": "2025-10-21T10:00:00.000Z",
  "updatedAt": "2025-10-21T10:00:00.000Z"
}
```

### 3. Criar Cobran√ßa com Cart√£o de Cr√©dito

```bash
curl -X POST http://localhost:3000/charges \
  -H "Content-Type: application/json" \
  -H "idempotency-key: 770e8400-e29b-41d4-a716-446655440000" \
  -d '{
    "customerId": "123e4567-e89b-12d3-a456-426614174000",
    "amount": 500.00,
    "paymentMethod": "credit_card",
    "description": "Compra de produto",
    "paymentDetails": {
      "cardNumber": "4111111111111111",
      "cardHolderName": "JOAO DA SILVA",
      "cardExpiration": "12/2028",
      "cardCvv": "123",
      "installments": 3
    }
  }'
```

### 4. Criar Cobran√ßa com Boleto

```bash
curl -X POST http://localhost:3000/charges \
  -H "Content-Type: application/json" \
  -H "idempotency-key: 880e8400-e29b-41d4-a716-446655440000" \
  -d '{
    "customerId": "123e4567-e89b-12d3-a456-426614174000",
    "amount": 250.00,
    "paymentMethod": "bank_slip",
    "description": "Mensalidade",
    "paymentDetails": {
      "bankSlipDueDate": "2025-10-30"
    }
  }'
```

### 5. Atualizar Status da Cobran√ßa

```bash
curl -X PATCH http://localhost:3000/charges/789e4567-e89b-12d3-a456-426614174000 \
  -H "Content-Type: application/json" \
  -d '{
    "status": "paid"
  }'
```

## üîí Idempot√™ncia

A API suporta idempot√™ncia em requisi√ß√µes POST atrav√©s do header `idempotency-key`:

```bash
-H "idempotency-key: 550e8400-e29b-41d4-a716-446655440000"
```

Se a mesma chave for enviada em m√∫ltiplas requisi√ß√µes, a API retornar√° o resultado da primeira requisi√ß√£o sem executar a opera√ß√£o novamente.

## üóÑÔ∏è Modelagem do Banco de Dados

### Entidade: Customer (Cliente)
```
- id: UUID (PK)
- name: VARCHAR(255)
- email: VARCHAR(255) UNIQUE
- document: VARCHAR(20) UNIQUE
- phone: VARCHAR(20)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### Entidade: Charge (Cobran√ßa)
```
- id: UUID (PK)
- customer_id: UUID (FK -> Customer)
- amount: DECIMAL(10,2)
- currency: VARCHAR(3)
- payment_method: ENUM (pix, credit_card, bank_slip)
- status: ENUM (pending, paid, failed, expired, cancelled)
- description: TEXT

# Campos espec√≠ficos do Pix
- pix_qr_code: TEXT
- pix_expiration: TIMESTAMP

# Campos espec√≠ficos do Cart√£o
- card_last_digits: VARCHAR(4)
- card_brand: VARCHAR(50)
- installments: INT

# Campos espec√≠ficos do Boleto
- bank_slip_code: VARCHAR(100)
- bank_slip_due_date: DATE
- bank_slip_url: TEXT

- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

## ‚úÖ Valida√ß√µes Implementadas

### Clientes
- Nome: m√≠nimo 3 caracteres, m√°ximo 255
- E-mail: formato v√°lido e √∫nico no sistema
- Documento: 11-14 d√≠gitos num√©ricos (CPF/CNPJ) e √∫nico no sistema
- Telefone: 10-11 d√≠gitos num√©ricos

### Cobran√ßas
- Valor: m√≠nimo 0.01, m√°ximo 2 casas decimais
- Cliente: deve existir no sistema
- M√©todo de pagamento: pix, credit_card ou bank_slip

#### Valida√ß√µes por M√©todo de Pagamento:

**Pix:**
- Data de expira√ß√£o (opcional, padr√£o: 24h)

**Cart√£o de Cr√©dito:**
- N√∫mero do cart√£o: 13-19 d√≠gitos
- Nome do titular: obrigat√≥rio
- Data de validade: formato MM/YYYY
- CVV: 3-4 d√≠gitos
- Parcelas: 1-12 (opcional, padr√£o: 1)

**Boleto:**
- Data de vencimento: obrigat√≥ria e deve ser futura

## üîÑ Status das Cobran√ßas

A cobran√ßa pode ter os seguintes status:

- `pending`: Aguardando pagamento
- `paid`: Pagamento confirmado
- `failed`: Pagamento falhou
- `expired`: Cobran√ßa expirou
- `cancelled`: Cobran√ßa cancelada

### Transi√ß√µes V√°lidas de Status

- `pending` ‚Üí `paid`, `failed`, `expired`, `cancelled`
- `failed` ‚Üí `pending`, `cancelled`
- `expired` ‚Üí `cancelled`
- `paid` e `cancelled` s√£o estados finais (n√£o podem ser alterados)

## üö® Tratamento de Erros

A API retorna erros padronizados no formato:

```json
{
  "statusCode": 400,
  "message": "Mensagem de erro",
  "timestamp": "2025-10-21T10:00:00.000Z"
}
```

### C√≥digos de Status HTTP

- `200` - OK
- `201` - Created
- `204` - No Content
- `400` - Bad Request (valida√ß√£o falhou)
- `404` - Not Found (recurso n√£o encontrado)
- `409` - Conflict (duplicidade)
- `500` - Internal Server Error

## üß™ Testando a API

### Via Swagger UI
1. Acesse http://localhost:3000/api/docs
2. Use a interface interativa para testar os endpoints

### Via curl
Veja os exemplos de uso acima

### Via Postman/Insomnia
Importe a cole√ß√£o do Swagger: http://localhost:3000/api/docs-json

## üèóÔ∏è Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ charges/              # M√≥dulo de cobran√ßas
‚îÇ   ‚îú‚îÄ‚îÄ dto/              # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ entities/         # Entidades do TypeORM
‚îÇ   ‚îú‚îÄ‚îÄ enums/            # Enumeradores
‚îÇ   ‚îú‚îÄ‚îÄ charges.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ charges.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ charges.module.ts
‚îú‚îÄ‚îÄ customers/            # M√≥dulo de clientes
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ customers.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ customers.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ customers.module.ts
‚îú‚îÄ‚îÄ common/               # Recursos compartilhados
‚îÇ   ‚îú‚îÄ‚îÄ filters/          # Filtros de exce√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ interceptors/     # Interceptors (idempot√™ncia)
‚îú‚îÄ‚îÄ config/               # Configura√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ database.config.ts
‚îú‚îÄ‚îÄ app.module.ts         # M√≥dulo principal
‚îú‚îÄ‚îÄ app.controller.ts
‚îú‚îÄ‚îÄ app.service.ts
‚îî‚îÄ‚îÄ main.ts               # Bootstrap da aplica√ß√£o
```

## üìù Scripts Dispon√≠veis

```bash
# Desenvolvimento
npm run start:dev

# Produ√ß√£o
npm run build
npm run start:prod

# Testes
npm run test
npm run test:e2e
npm run test:cov

# Lint
npm run lint
npm run format
```

## üê≥ Docker

### Subir os servi√ßos
```bash
docker-compose up -d
```

### Ver logs
```bash
docker-compose logs -f app
```

### Parar os servi√ßos
```bash
docker-compose down
```

### Remover volumes (dados do banco)
```bash
docker-compose down -v
```

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa UNLICENSED.

## üìß Contato

Para d√∫vidas ou sugest√µes, entre em contato.

---

**Desenvolvido com ‚ù§Ô∏è usando NestJS**
